<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#1b191b"/>
  <meta name="color-scheme" content="dark"/>
  <title>Trader Prep</title>

  <!-- Icons / Manifest -->
  <link rel="icon" href="favicon-32.png" sizes="32x32" type="image/png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Icons (CDN, free) -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer"/>

  <style>
    :root {
      --bg:#1b191b; --panel:#2a292f; --panel-2:#242328; --line:#35343a;
      --fg:#f1f2f4; --muted:#a7adbb;
      --accent:#6424ac;           /* main purple */
      --accent-graph:#7c5cff;     /* bright line purple */
      --ok:#6abd74; --bad:#e05d5d; --warn:#d3a54a; --pill:#24252b;
      --shadow:0 6px 18px rgba(0,0,0,.35); --radius:14px; --pad:16px;
    }
    html,body{background:var(--bg);color:var(--fg)}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;margin:0;line-height:1.35;word-break:break-word}
    a{color:inherit}

    /* Top bar */
    .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,#201f25 0%,#1a191f 100%);border-bottom:1px solid var(--line);padding:10px 14px}
    .brand{display:flex;gap:10px;align-items:center;min-width:0}
    .brand .logo{width:36px;height:36px;display:grid;place-items:center;border-radius:10px;background:#2f2e36;border:1px solid var(--line);overflow:hidden;flex:0 0 auto}
    .brand .logo img{width:100%;height:100%;object-fit:contain}
    .brand h1{font-size:16px;margin:0;letter-spacing:.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .navicons{display:flex;gap:10px;align-items:center}
    .iconbtn{min-width:44px;min-height:44px;display:grid;place-items:center;border-radius:12px;border:1px solid var(--line);background:#26252b;cursor:pointer;color:#cfd3dc}
    .iconbtn.active{background:var(--accent);color:#090909;border-color:transparent}

    /* Stat strip */
    .statstrip{display:flex;gap:10px;align-items:center;padding:10px 14px;flex-wrap:wrap;border-bottom:1px solid var(--line);background:#1e1d22}
    .chip{display:flex;gap:8px;align-items:center;padding:6px 10px;background:#2a2930;border:1px solid var(--line);border-radius:10px;font-size:12px}
    .chip.ok{background:#213224;color:var(--ok);border-color:#2a4930}
    .chip.warn{background:#332d1f;color:var(--warn);border-color:#5a4726}
    .chip.bad{background:#372325;color:var(--bad);border-color:#5d3439}

    /* Shell */
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow);margin:14px 0}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button,select,input{font-size:15px}
    select,input{background:var(--panel-2);color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:12px 12px;width:100%}
    button{padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:var(--panel-2);color:var(--fg);cursor:pointer}
    .primary{background:var(--accent);color:#0b0b10;border-color:transparent;font-weight:600}
    .tabs{display:flex;gap:10px;margin:8px 0 2px;flex-wrap:wrap}
    .tabbtn{border-radius:10px;border:1px solid var(--line);background:#26252b;padding:8px 12px;cursor:pointer}
    .tabbtn.active{background:var(--accent);color:#0b0b10;border-color:transparent}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 12px;border-radius:999px;background:var(--pill);border:1px solid var(--line);font-size:13px}
    .pill.accent{background:var(--accent);color:#0b0b10;border-color:transparent}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    details summary{cursor:pointer}
    .bundles{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .bundle{padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#26252b;font-size:14px;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    /* Chart canvas */
    .chart{width:100%;height:190px;border-radius:10px;background:#24252b;margin-top:10px;display:block}
    .legend{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:8px;font-size:12px;color:var(--muted)}
    .legend .item{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#26252b}
    .swatch{display:inline-block;width:20px;height:10px;border-radius:2px}
    .swatch.line{width:28px;height:0;border-top:3px solid currentColor}
    .swatch.dashed{border-top-style:dashed}

    .seg{display:flex;gap:8px;flex-wrap:wrap}
    .segbtn{padding:8px 12px;border:1px solid var(--line);background:#26252b;border-radius:10px;cursor:pointer}
    .segbtn.active{background:var(--accent);color:#0b0b10;border-color:transparent}
    .spinner{display:inline-block;width:18px;height:18px;border:3px solid #45434c;border-top-color:#ddd;border-radius:50%;animation:spin 1s linear infinite;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .flash{animation:flash .6s ease}@keyframes flash{0%{color:var(--ok)}100%{color:var(--muted)}}

    /* Mobile */
    #mobileMenu{display:none}
    @supports(padding:max(0px)){.topbar{padding-top:calc(10px + env(safe-area-inset-top))}}
    @media (max-width:520px){
      #mobileMenu{display:grid}
      #navicons{display:none;position:absolute;right:8px;top:calc(100% + 6px);background:#26252b;border:1px solid var(--line);border-radius:12px;padding:6px;box-shadow:var(--shadow);z-index:60}
      #navicons.show{display:flex}
      .brand h1{max-width:46vw}
      .legend{font-size:11px}
      .chip{font-size:11px}
      .tabbtn,button{padding:10px 12px}
      .pill{white-space:nowrap}
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header class="topbar">
    <div class="brand">
      <div class="logo"><img src="icon-192.png" alt="Trader Prep Logo"></div>
      <h1>Trader Prep</h1>
    </div>

    <nav class="navicons" id="navicons">
      <div class="iconbtn active" id="nav-prep" title="Prep"><i class="fa-solid fa-bars-staggered"></i></div>
      <div class="iconbtn" id="nav-trend" title="Trend"><i class="fa-solid fa-wave-square"></i></div>
      <div class="iconbtn" id="nav-risk" title="Risk"><i class="fa-solid fa-fire-flame-curved"></i></div>
      <div class="iconbtn" id="nav-pnl" title="Profit Log"><i class="fa-solid fa-dollar-sign"></i></div>
      <div class="iconbtn" id="nav-settings" title="Settings"><i class="fa-solid fa-gear"></i></div>
    </nav>

    <button class="iconbtn" id="mobileMenu" title="Menu">
      <i class="fa-solid fa-ellipsis-vertical"></i>
    </button>
  </header>

  <!-- STATS -->
  <div class="statstrip">
    <div class="chip" id="chipAKWrap"><span class="muted">AK$ (today):</span> <strong id="chipAK">$0.00</strong><span class="muted" style="margin-left:8px">/ all:</span> <strong id="chipAKAll">$0.00</strong></div>
    <div class="chip" id="chipBGWrap"><span class="muted">BG$ (today):</span> <strong id="chipBG">$0.00</strong><span class="muted" style="margin-left:8px">/ all:</span> <strong id="chipBGAll">$0.00</strong></div>
    <div class="chip ok" id="conn1"><i class="fa-solid fa-signal"></i> API OK</div>
    <div class="chip ok" id="conn2"><i class="fa-solid fa-chart-line"></i> Data OK</div>
  </div>

  <div class="wrap">
    <!-- SETTINGS -->
    <div class="card" id="panel-settings" style="display:none">
      <div class="row"><strong>Settings</strong><span class="muted">(Keys optional; proxy fallback built-in)</span></div>
      <div class="row" style="margin-top:10px"><label class="muted" style="min-width:170px">GNews API Key</label><input id="gnews" placeholder="gnews.io token"></div>
      <div class="row" style="margin-top:10px"><label class="muted" style="min-width:170px">Alpha Vantage Key</label><input id="alpha" placeholder="alphavantage.co key"></div>
      <div class="actions" style="margin-top:10px"><button id="saveKeys" class="primary"><i class="fa-regular fa-floppy-disk"></i>&nbsp;Save Keys</button><span id="saveMsg" class="muted"></span></div>
    </div>

    <!-- PNL -->
    <div class="card" id="panel-pnl" style="display:none">
      <div class="row"><strong>Daily P&L Log</strong><span class="muted">(updates AK$/BG$ chips for today)</span></div>
      <div class="row" style="margin-top:10px"><label class="muted" style="min-width:170px">Who</label><div class="actions"><label><input type="radio" name="who" value="AK" checked> AK</label><label style="margin-left:10px"><input type="radio" name="who" value="BG"> BG</label></div></div>
      <div class="row" style="margin-top:10px"><label class="muted" style="min-width:170px">Amount ($)</label><input id="pnlAmount" placeholder="e.g. 125.50 or -75"></div>
      <div class="row" style="margin-top:10px"><label class="muted" style="min-width:170px">Note (optional)</label><input id="pnlNote" placeholder="scalp NQ open, etc."></div>
      <div class="actions" style="margin-top:10px"><button id="logPnl" class="primary"><i class="fa-solid fa-plus"></i>&nbsp;Log Profit</button><span id="pnlMsg" class="muted"></span></div>
      <details style="margin-top:12px"><summary>Today’s entries</summary><div id="pnlTodayTable" class="muted" style="margin-top:8px">—</div><div class="actions" style="margin-top:8px"><button id="undoLast"><i class="fa-solid fa-rotate-left"></i>&nbsp;Undo last entry</button></div></details>
    </div>

    <!-- MARKET PICKER -->
    <div class="card" id="panel-picker">
      <div class="tabs">
        <button class="tabbtn active" id="tab-prep">Prep</button>
        <button class="tabbtn" id="tab-trend">Trend</button>
        <button class="tabbtn" id="tab-risk">Risk</button>
      </div>
      <strong>Choose your markets</strong>
      <div class="bundles">
        <button class="bundle" data-bundle="ES,NQ,YM,RTY">US Indices</button>
        <button class="bundle" data-bundle="CL,GC">Energy & Gold</button>
        <button class="bundle" data-bundle="ZN,6E">Rates / FX</button>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label class="muted">Futures/markets</label>
          <select id="futures" multiple size="8" aria-label="Futures and markets">
            <option value="ES">ES – S&P 500</option>
            <option value="NQ">NQ – Nasdaq 100</option>
            <option value="YM">YM – Dow</option>
            <option value="RTY">RTY – Russell 2000</option>
            <option value="CL">CL – Crude Oil</option>
            <option value="GC">GC – Gold</option>
            <option value="ZN">ZN – 10-Yr Note</option>
            <option value="6E">6E – EUR/USD</option>
          </select>
        </div>
        <div>
          <div class="muted">Trend/Risk timeframe</div>
          <div class="seg" id="tfSeg" style="margin-top:6px">
            <button class="segbtn active" data-tf="15">15m</button>
            <button class="segbtn" data-tf="30">30m</button>
            <button class="segbtn" data-tf="60">60m</button>
          </div>
          <div class="muted" style="margin-top:6px">Trend/Risk use 1-minute Yahoo bars (via proxy), mapped futures → ETFs.</div>
        </div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button id="start" class="primary"><i class="fa-solid fa-bolt"></i>&nbsp;Analyze (Prep)</button>
        <button id="runTrend" class="primary"><i class="fa-solid fa-wave-square"></i>&nbsp;Analyze (Trend)</button>
        <button id="runRisk" class="primary"><i class="fa-solid fa-fire-flame-curved"></i>&nbsp;Analyze (Risk)</button>
      </div>
    </div>

    <!-- PREP -->
    <div id="prepOut" class="card">
      <div class="row"><strong>Trader Prep</strong><span class="muted">Now: <span id="now"></span></span></div>
      <div class="muted">Focus: <span id="focus"></span> • <span id="keyStatus"></span></div>
      <div id="summary" style="margin-top:12px"></div>
      <h3 style="margin-top:16px">Quick Links</h3>
      <ul id="links"></ul>
    </div>

    <!-- TREND -->
    <div id="trendOut" class="card" style="display:none">
      <div class="row"><strong>Current Trend</strong><span class="muted">Window: <span id="trendWin">15m</span></span></div>
      <div class="muted">Primary: <span id="trendSym"></span> (mapped ETF) • <span id="trendTime"></span></div>
      <div id="trendSummary" style="margin-top:12px"></div>
      <canvas id="trendChart" class="chart"></canvas>
      <div id="trendLegend" class="legend"></div>
      <div id="trendAdvice" style="margin-top:12px"></div>
      <div class="muted" style="margin-top:6px;font-size:12px">Last refreshed: <span id="trendRef">—</span></div>
      <details style="margin-top:10px"><summary>How we decide “busy”</summary>
        <div class="muted" style="margin-top:6px">We compute 1-minute returns and flag as <b>Busy</b> when realized vol in the window is elevated (≥ ~0.06% std-dev) or average volume is above the window’s median (≥ 1.2×).</div>
      </details>
    </div>

    <!-- RISK -->
    <div id="riskOut" class="card" style="display:none">
      <div class="row"><strong>Risk Read</strong><span class="muted">Window: <span id="riskWin">15m</span></span></div>

      <div class="seg" id="riskModeSeg" style="margin:6px 0 2px">
        <button class="segbtn active" data-mode="conservative">Conservative</button>
        <button class="segbtn" data-mode="aggressive">Aggressive</button>
      </div>

      <div class="row sliderrow" style="margin:4px 0 8px">
        <span class="muted" style="min-width:120px">Candles (1m each)</span>
        <input id="riskCandles" type="range" min="3" max="15" step="1" value="3" aria-label="Risk candles">
        <span class="pill" id="riskCandlesLabel">3 candles</span>
      </div>

      <div class="muted">Primary: <span id="riskSym"></span> (mapped ETF) • <span id="riskTime"></span></div>
      <div id="riskSummary" style="margin-top:12px"></div>
      <canvas id="riskChart" class="chart"></canvas>
      <div id="riskLegend" class="legend"></div>
      <div id="riskAdvice" style="margin-top:12px"></div>
      <div class="muted" style="margin-top:6px;font-size:12px">Last refreshed: <span id="riskRef">—</span></div>
    </div>
  </div>

  <!-- Why Modal -->
  <div class="modal" id="whyModal" role="dialog" aria-modal="true" aria-labelledby="whyTitle" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:80">
    <div class="sheet" style="background:var(--panel);border:1px solid var(--line);border-radius:16px;max-width:640px;width:92vw;padding:14px;box-shadow:var(--shadow)">
      <button class="pill close" style="float:right" id="whyClose">Close</button>
      <h3 id="whyTitle">Why this suggestion?</h3>
      <div id="whyBody" class="muted"></div>
    </div>
  </div>

  <script>
  /* ---------------- Config ---------------- */
  const PROXY_RAW = 'https://script.google.com/macros/s/AKfycbztzwYcRxD3mQ2MgD99ubT3-nW-nQJiU-thNoUrdRuMkrTIF1LilnEyCbysHP6Z7HYf/exec?url=';

  // ===== PnL API (optional) =====
  const PNL_API   = 'https://script.google.com/macros/s/AKfycbz2b9H8BLD7BvWfbtWaPnaThvUHM66MsnBcDb0_siM5L_xxqj1MrfqSPk1uOjvbbNx0/exec'; // <-- no ?url=
  const PNL_TOKEN = 'CHANGE_ME_32CHAR';

  /* ---------------- Nav / Tabs ---------------- */
  const panelSettings=document.getElementById('panel-settings');
  const panelPnL=document.getElementById('panel-pnl');
  const navPrep=document.getElementById('nav-prep'),navTrend=document.getElementById('nav-trend'),navSettings=document.getElementById('nav-settings'),navPnL=document.getElementById('nav-pnl'),navRisk=document.getElementById('nav-risk');

  function hidePanels(){panelSettings.style.display='none';panelPnL.style.display='none'}
  function setNav(active){
    [navPrep,navTrend,navSettings,navPnL,navRisk].forEach(n=>n.classList.toggle('active',n.id===active));
    hidePanels();
    if(active==='nav-settings') panelSettings.style.display='block';
    if(active==='nav-pnl') panelPnL.style.display='block';
    if(active==='nav-prep') setTab('prep');
    if(active==='nav-trend') setTab('trend');
    if(active==='nav-risk') setTab('risk');
  }
  navPrep.onclick=()=>setNav('nav-prep'); navTrend.onclick=()=>setNav('nav-trend'); navSettings.onclick=()=>setNav('nav-settings'); navPnL.onclick=()=>setNav('nav-pnl'); navRisk.onclick=()=>setNav('nav-risk');

  const tabPrep=document.getElementById('tab-prep'), tabTrend=document.getElementById('tab-trend'), tabRisk=document.getElementById('tab-risk');
  const prepOut=document.getElementById('prepOut'), trendOut=document.getElementById('trendOut'), riskOut=document.getElementById('riskOut');
  function setTab(which){
    tabPrep.classList.toggle('active',which==='prep');
    tabTrend.classList.toggle('active',which==='trend');
    tabRisk.classList.toggle('active',which==='risk');
    prepOut.style.display=(which==='prep')?'':'none';
    trendOut.style.display=(which==='trend')?'':'none';
    riskOut.style.display=(which==='risk')?'':'none';
  }

  /* ---------------- Elements ---------------- */
  const futuresSel=document.getElementById('futures');
  const startBtn=document.getElementById('start'), runTrendBtn=document.getElementById('runTrend'), runRiskBtn=document.getElementById('runRisk');
  const nowEl=document.getElementById('now'), focusEl=document.getElementById('focus'), summaryEl=document.getElementById('summary'), linksEl=document.getElementById('links');
  const keyStatusEl=document.getElementById('keyStatus'), gnewsEl=document.getElementById('gnews'), alphaEl=document.getElementById('alpha');
  const saveBtn=document.getElementById('saveKeys'), saveMsg=document.getElementById('saveMsg');

  const trendWinEl=document.getElementById('trendWin'), trendSymEl=document.getElementById('trendSym'), trendTimeEl=document.getElementById('trendTime'), trendSummaryEl=document.getElementById('trendSummary'), trendAdviceEl=document.getElementById('trendAdvice'), trendCanvas=document.getElementById('trendChart');
  const riskWinEl=document.getElementById('riskWin'), riskSymEl=document.getElementById('riskSym'), riskTimeEl=document.getElementById('riskTime'), riskSummaryEl=document.getElementById('riskSummary'), riskAdviceEl=document.getElementById('riskAdvice'), riskCanvas=document.getElementById('riskChart');
  const trendLegend=document.getElementById('trendLegend');
  const riskLegend=document.getElementById('riskLegend');

  // Modal
  const whyModal=document.getElementById('whyModal'), whyBody=document.getElementById('whyBody'), whyClose=document.getElementById('whyClose');

  /* ---------------- Timeframe ---------------- */
  let trendMinutes=15;
  const segBtns=document.querySelectorAll('.segbtn[data-tf]');
  function setTfActive(mins){
    segBtns.forEach(btn=>btn.classList.toggle('active',parseInt(btn.dataset.tf,10)===mins));
    trendMinutes=mins; trendWinEl.textContent=mins+'m'; riskWinEl.textContent=mins+'m';
  }
  segBtns.forEach(btn=>btn.addEventListener('click',()=>setTfActive(parseInt(btn.dataset.tf,10))));

  /* ---------------- Keys ---------------- */
  function loadKeys(){gnewsEl.value=localStorage.getItem('GNEWS_KEY')||'';alphaEl.value=localStorage.getItem('ALPHA_KEY')||''}
  function saveKeys(){localStorage.setItem('GNEWS_KEY',gnewsEl.value.trim());localStorage.setItem('ALPHA_KEY',alphaEl.value.trim());saveMsg.textContent='Saved ✓';setTimeout(()=>saveMsg.textContent='',1500)}
  if(saveBtn){loadKeys(); saveBtn.addEventListener('click',saveKeys);}

  /* ---------------- Futures helpers ---------------- */
  function sigmoid(x){return 1/(1+Math.exp(-x))}
  function stdev(arr){if(!arr.length)return 0;const m=arr.reduce((a,b)=>a+b,0)/arr.length;const v=arr.reduce((a,b)=>a+(b-m)*(b-m),0)/arr.length;return Math.sqrt(v)}
  function mad(arr){if(!arr.length)return 0;const m=arr.reduce((a,b)=>a+b,0)/arr.length;const dev=arr.map(x=>Math.abs(x-m)).sort((a,b)=>a-b);const mid=Math.floor(dev.length/2);return dev.length%2?dev[mid]:(dev[mid-1]+dev[mid])/2}
  function ema(arr,a=0.25){const out=[];let s=null;for(const x of arr){s=(s==null)?x:a*x+(1-a)*s;out.push(s)}return out}
  function slopePctPerHour(vals){if(vals.length<3)return 0;const first=vals[0];let sx=0,sy=0,sxx=0,sxy=0;for(let i=0;i<vals.length;i++){sx+=i;sy+=vals[i];sxx+=i*i;sxy+=i*vals[i]}const n=vals.length,den=(n*sxx-sx*sx)||1;const slope=(n*sxy-sx*sy)/den;return (first>0)?(slope/first)*60*100:0}

  function getSelectedFutures(){return Array.from(futuresSel.selectedOptions).map(o=>o.value)}
  document.querySelectorAll('.bundle[data-bundle]').forEach(b=>b.addEventListener('click',()=>{const arr=b.dataset.bundle.split(',');for(const o of futuresSel.options)o.selected=arr.includes(o.value)}));

  function showPrepHeader(markets){nowEl.textContent=new Date().toLocaleString();focusEl.textContent=markets.join(', ')}
  function makeLinks(markets){const q=encodeURIComponent(markets.join(' ')||'ES NQ');linksEl.innerHTML=`<li><a target="_blank" href="https://www.google.com/search?q=index+futures">Index Futures Snapshot</a></li><li><a target="_blank" href="https://www.google.com/search?q=today+economic+calendar">Economic Calendar</a></li><li><a target="_blank" href="https://news.google.com/">Macro headlines</a></li><li><a target="_blank" href="https://news.google.com/search?q=${q}">News for ${markets.join(', ')}</a></li>`}

  /* ---------------- Maps ---------------- */
  const FUTURES_TO_ETF={ES:'SPY',NQ:'QQQ',YM:'DIA',RTY:'IWM',CL:'USO',GC:'GLD',ZN:'IEF','6E':'FXE'};
  const ETF_TO_STOOQ={SPY:'spy.us',QQQ:'qqq.us',DIA:'dia.us',IWM:'iwm.us',USO:'uso.us',GLD:'gld.us',IEF:'ief.us',FXE:'fxe.us'};

  /* ---------------- Sentiment rules ---------------- */
  const POS=['beat','surge','strong','record','optim','rally','up','gain','bull','expand','growth'];
  const NEG=['miss','fall','weak','cut','warn','down','bear','slump','contract','decline','risk','halt','ban','tariff'];
  function headlineScore(t){const s=t.toLowerCase();let n=0;POS.forEach(w=>{if(s.includes(w))n++});NEG.forEach(w=>{if(s.includes(w))n--});return n}
  function overallLabel(score){if(score>=2)return['Bullish','ok'];if(score<=-2)return['Bearish','bad'];return['Neutral','warn']}

  const CAUSE_RULES=[
    {key:'fed',label:'Fed/Rate outlook',pat:/(fed|powell|fomc|rate cut|rate hike|yield|treasury|dot plot|t-bill|t-note|t-bond)/i,w:2},
    {key:'cpi',label:'Inflation (CPI/PCE)',pat:/(cpi|pce|inflation|core inflation|ppi)/i,w:2},
    {key:'jobs',label:'Labor data',pat:/(nonfarm|nfp|payrolls|unemployment|jobless|initial claims|jolts)/i,w:2},
    {key:'gdp',label:'Growth data',pat:/(gdp|growth|pmis?)/i,w:1},
    {key:'earnings',label:'Earnings',pat:/(earnings|eps|revenue|guidance|beats?|miss(es)?|outlook|forecast)/i,w:2},
    {key:'mega',label:'Mega-cap tech',pat:/(apple|aapl|microsoft|msft|amazon|amzn|google|alphabet|googl|meta|fb|nvidia|nvda|tsla)/i,w:2},
    {key:'china',label:'China',pat:/(china|beijing|shanghai|pboc|property crisis|evergrande)/i,w:1},
    {key:'geopol',label:'Geopolitics',pat:/(war|missile|strike|conflict|israel|ukraine|taiwan|sanction|tariff|houthis?)/i,w:2},
    {key:'oil',label:'Oil/Energy',pat:/(oil|brent|wti|opec|opec\+|gasoline|refinery|energy prices?)/i,w:1},
    {key:'banks',label:'Banks/Credit',pat:/(bank(s)?|credit|default|downgrade|upgrade|capital|liquidity|stress test)/i,w:1},
    {key:'crypto',label:'Crypto',pat:/(bitcoin|btc|ethereum|eth|crypto|spot etf)/i,w:1},
    {key:'reg',label:'Regulation/Policy',pat:/(regulat(e|ion)|antitrust|probe|ftc|doj|ec|ban|export controls?)/i,w:1}
  ];
  const WHY_PCT=0.35;

  function topCausesFromHeadlines(headlines,max=3){
    const scores=new Map();const examples={};
    for(const h of (headlines||[])){for(const r of CAUSE_RULES){if(r.pat.test(h)){scores.set(r.key,(scores.get(r.key)||0)+r.w);if(!examples[r.key])examples[r.key]=h}}}
    return Array.from(scores.entries()).sort((a,b)=>b[1]-a[1]).slice(0,max).map(([key,score])=>({key,score,label:CAUSE_RULES.find(rr=>rr.key===key).label,sample:examples[key]}))
  }
  function moveDescriptor(pct){const ap=Math.abs(pct);if(ap>=2)return'surging';if(ap>=1)return'up solidly';if(ap>=0.5)return'firm';if(ap>=0.2)return'slightly higher';return'little changed'}
  function buildWhyNarrative({dayRes,headlines}){const parts=[];if(dayRes?.ok){const dir=dayRes.pct>=0?'higher':'lower',tone=moveDescriptor(dayRes.pct);parts.push(\`Markets are \${tone} (\${dayRes.pct.toFixed(2)}% \${dir} for \${dayRes.etf} at the last close).\`)}const causes=topCausesFromHeadlines(headlines,3);if(causes.length){parts.push(\`Likely drivers: \${causes.map(c=>c.label).join(', ')}.\`);const s=causes[0].sample;if(s)parts.push(\`e.g., “\${s.replace(/"/g,'')}”.\`)}else parts.push(\`No dominant driver detected; tone appears mixed.\`);return parts.join(' ')}

  /* ---------------- Fetch helpers ---------------- */
  async function fetchJsonOnce(u,t=9000){const c=new AbortController();const to=setTimeout(()=>c.abort('timeout'),t);try{const r=await fetch(u,{signal:c.signal,cache:'no-store'});if(!r.ok)throw new Error('HTTP '+r.status);return await r.json()}finally{clearTimeout(to)}}
  async function fetchJsonRetry(u,tries=2){let e=null;for(let i=0;i<tries;i++){try{return await fetchJsonOnce(u,i?12000:9000)}catch(x){e=x;await new Promise(r=>setTimeout(r,300))}}throw e}
  async function fetchTextOnce(u,t=9000){const c=new AbortController();const to=setTimeout(()=>c.abort('timeout'),t);try{const r=await fetch(u,{signal:c.signal,cache:'no-store'});if(!r.ok)throw new Error('HTTP '+r.status);return await r.text()}finally{clearTimeout(to)}}
  async function fetchTextRetry(u,tries=2){let e=null;for(let i=0;i<tries;i++){try{return await fetchTextOnce(u,i?12000:9000)}catch(x){e=x;await new Promise(r=>setTimeout(r,300))}}throw e}

  /* ---------------- Headlines ---------------- */
  async function getHeadlines(markets){
    const gkey=(localStorage.getItem('GNEWS_KEY')||'').trim();
    if(gkey){try{const q=encodeURIComponent(markets.join(' OR '));const url=\`https://gnews.io/api/v4/search?q=\${q}&lang=en&country=us&max=20&token=\${gkey}\`;const data=await fetchJsonRetry(url,2);const headlines=(data.articles||[]).map(a=>a.title||'').filter(Boolean);return {ok:true,source:'gnews',headlines}}catch(e){}}
    const q=encodeURIComponent(markets.join(' '));const rss=\`https://news.google.com/rss/search?q=\${q}&hl=en-US&gl=US&ceid=US:en&t=\${Date.now()}\`;
    try{const xml=await fetchTextRetry(PROXY_RAW+encodeURIComponent(rss),2);const doc=new DOMParser().parseFromString(xml,'text/xml');const items=Array.from(doc.querySelectorAll('item>title'));const heads=items.map(n=>n.textContent||'').filter(Boolean);return {ok:heads.length>0,source:'rss-proxy',headlines:heads}}catch(e){return {ok:false,source:'rss-proxy',reason:String(e)}}}

  /* ---------------- Last day (Alpha→Yahoo→Stooq) ---------------- */
  async function getLastDayMove(markets){
    const akey=(localStorage.getItem('ALPHA_KEY')||'').trim();
    const etf=FUTURES_TO_ETF[markets[0]||'ES']||'SPY';
    if(akey){try{const url=\`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=\${etf}&apikey=\${akey}\`;const data=await fetchJsonRetry(url,2);const s=data['Time Series (Daily)']||{};const d=Object.keys(s).sort().reverse();if(d.length>=2){const c0=parseFloat(s[d[0]]['4. close']), c1=parseFloat(s[d[1]]['4. close']);const pct=((c0-c1)/c1)*100, delta=c0-c1;const closes=d.slice(0,10).reverse().map(k=>parseFloat(s[k]['4. close'])).filter(n=>isFinite(n));return {ok:true,etf,latest:d[0],prior:d[1],pct,delta,closes,source:'alpha'}}}catch(e){}}
    try{const yUrl=\`https://query1.finance.yahoo.com/v8/finance/chart/\${encodeURIComponent(etf)}?range=15d&interval=1d&t=\${Date.now()}\`;const yData=await fetchJsonRetry(PROXY_RAW+encodeURIComponent(yUrl),2);const r=yData?.chart?.result?.[0];const closes=r?.indicators?.quote?.[0]?.close?.filter(v=>v!=null)||[];if(closes.length>=2){const c0=closes.at(-1), c1=closes.at(-2);const pct=((c0-c1)/c1)*100, delta=c0-c1;const ts=r.timestamp||[];const toDate=t=>{const d=new Date(t*1000);return \`\${d.getFullYear()}-\${String(d.getMonth()+1).padStart(2,'0')}-\${String(d.getDate()).padStart(2,'0')}\`};const latest=ts.length?toDate(ts.at(-1)):'', prior=ts.length>1?toDate(ts.at(-2)):'';return {ok:true,etf,latest,prior,pct,delta,closes:closes.slice(-10),source:'yahoo-proxy'}}}catch(e){}
    const sym=ETF_TO_STOOQ[etf]||'spy.us';const srcs=[\`https://stooq.com/q/d/l/?s=\${encodeURIComponent(sym)}&i=d&t=\${Date.now()}\`,\`https://stooq.pl/q/d/l/?s=\${encodeURIComponent(sym)}&i=d&t=\${Date.now()}\`];
    let lastErr=null;for(const u of srcs){try{const csv=await fetchTextRetry(PROXY_RAW+encodeURIComponent(u),2);const rows=csv.trim().split('\\n');if(rows.length>=3){const last=rows.at(-1).split(','), prev=rows.at(-2).split(',');const c0=parseFloat(last[4]), c1=parseFloat(prev[4]);if(!isFinite(c0)||!isFinite(c1)) throw new Error('bad close');const pct=((c0-c1)/c1)*100, delta=c0-c1;const closes=rows.slice(-11).slice(1).map(r=>parseFloat(r.split(',')[4])).filter(v=>isFinite(v));return {ok:true,etf,latest:last[0],prior:prev[0],pct,delta,closes,source:u.includes('.pl')?'stooq-proxy(pl)':'stooq-proxy(com)'}}}catch(e){lastErr=e}}return {ok:false,reason:String(lastErr||'fetch failed')}}
  function sentimentFrom(h){const total=h.reduce((a,t)=>a+headlineScore(t),0);const [label,cls]=overallLabel(total);return {label,cls,total}}
  function drawSparkline(container,values){if(!values||values.length<2)return;const c=document.createElement('canvas');c.className='chart';container.appendChild(c);drawLineChart(c,values.map((v,i)=>({c:v,t:i})))}

  /* ---------------- Charts ---------------- */
  function sizeCanvas(canvas){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const cssW = canvas.clientWidth || 700;
    const cssH = canvas.clientHeight || 190;
    canvas.width  = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    return { ctx: canvas.getContext('2d'), w: canvas.width, h: canvas.height, dpr };
  }

  function drawCandleChart(canvas, bars, opts={}){
    const {ctx,w,h}=sizeCanvas(canvas);
    ctx.clearRect(0,0,w,h);
    if(!bars || bars.length<2) return;
    const pad=12;
    const highs=bars.map(b=>b.h), lows=bars.map(b=>b.l);
    const min=Math.min(...lows), max=Math.max(...highs), range=(max-min)||1;
    const step=(w-pad*2)/(bars.length-1);
    const bodyFrac=0.65, bodyW=Math.max(3, step*bodyFrac);

    // grid
    ctx.strokeStyle = '#2d2d33'; ctx.lineWidth = 1;
    for (let i=1;i<=3;i++){
      const y = pad + (h - pad*2) * (i/4);
      ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(w-pad,y); ctx.stroke();
    }

    // candles
    for (let i=0;i<bars.length;i++){
      const b=bars[i], x=pad+step*i;
      const yH=h-pad-((b.h-min)/range)*(h-pad*2);
      const yL=h-pad-((b.l-min)/range)*(h-pad*2);
      const yO=h-pad-((b.o-min)/range)*(h-pad*2);
      const yC=h-pad-((b.c-min)/range)*(h-pad*2);
      const up=b.c>=b.o;

      ctx.strokeStyle=up?'#6abd74':'#e05d5d';
      ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x,yH); ctx.lineTo(x,yL); ctx.stroke();

      const top=Math.min(yO,yC), bot=Math.max(yO,yC);
      ctx.fillStyle=up?'#6abd74':'#e05d5d';
      ctx.fillRect(x-bodyW/2, top, bodyW, Math.max(2, bot-top));
    }

    // VWAP proxy (dashed purple)
    if(opts.vwap){
      let cumPV=0,cumV=0;
      ctx.beginPath();
      ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()||'#6f5aff';
      ctx.setLineDash([5,4]); ctx.lineWidth=2;
      for (let i=0;i<bars.length;i++){
        const b=bars[i], x=pad+step*i;
        cumPV += (b.c||b.o)*(b.v||1);
        cumV  += (b.v||1);
        const vwap=cumPV/Math.max(1,cumV);
        const y=h-pad-((vwap-min)/range)*(h-pad*2);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke(); ctx.setLineDash([]);
    }

    // close line (solid bright purple)
    if(opts.closeLine){
      ctx.beginPath();
      const color=getComputedStyle(document.documentElement).getPropertyValue('--accent-graph').trim()||'#7c5cff';
      ctx.strokeStyle=color; ctx.lineWidth=1.75;
      for (let i=0;i<bars.length;i++){
        const b=bars[i], x=pad+step*i;
        const y=h-pad-((b.c-min)/range)*(h-pad*2);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }
  }
  function drawLineChart(canvas,points){
    const {ctx,w,h}=sizeCanvas(canvas);
    if(!points || points.length<2) return;
    const pad=10; const min=Math.min(...points.map(p=>p.c)), max=Math.max(...points.map(p=>p.c)); const range=(max-min)||1;
    const step=(w-pad*2)/(points.length-1);
    ctx.beginPath();
    ctx.lineWidth=2; ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent-graph').trim()||'#7c5cff';
    points.forEach((p,i)=>{const x=pad+step*i; const y=h-pad-((p.c-min)/range)*(h-pad*2); if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y)});
    ctx.stroke();
  }
  function drawTrend(canvas,bars){ drawCandleChart(canvas,bars,{vwap:true,closeLine:true}); }
  function drawRisk(canvas,bars){ drawCandleChart(canvas,bars,{vwap:true,closeLine:true}); }

  /* ---------------- Prep summary ---------------- */
  async function buildSummary(markets){
    nowEl.textContent=new Date().toLocaleString();
    const gkey=(localStorage.getItem('GNEWS_KEY')||'').trim(), akey=(localStorage.getItem('ALPHA_KEY')||'').trim();
    keyStatusEl.textContent=(!gkey||!akey)?'Using proxy for any missing services.':'Using saved API keys where available.';
    summaryEl.innerHTML='<span class="spinner"></span> Analyzing...';
    let newsRes={ok:false,reason:'timeout'}, dayRes={ok:false,reason:'timeout'};
    try{newsRes=await getHeadlines(markets)}catch(e){newsRes={ok:false,reason:String(e)}}
    try{dayRes=await getLastDayMove(markets)}catch(e){dayRes={ok:false,reason:String(e)}}
    const parts=[];
    if(newsRes.ok&&newsRes.headlines?.length){
      const senti=sentimentFrom(newsRes.headlines);
      const overall=senti.total>=2?'lean <b>bullish</b>':(senti.total<=-2?'lean <b>bearish</b>':'look <b>mixed/neutral</b>');
      parts.push(`<div class="pill ${senti.cls}"><i class="fa-regular fa-newspaper"></i> News sentiment (${newsRes.source}): <strong>${senti.label}</strong></div>`);
      parts.push(`<p style="margin-top:8px">According to current news, <b>${markets.join(', ')}</b> ${overall} as of now.</p>`);
      const top=newsRes.headlines.slice(0,5).map(h=>`<li>${h}</li>`).join('');
      parts.push(`<details style="margin-top:6px"><summary>Top headlines</summary><ul>${top}</ul></details>`);
    } else {
      parts.push(`<div class="muted"><i class="fa-regular fa-newspaper"></i> News sentiment unavailable${newsRes.reason?' ('+newsRes.reason+')':''}</div>`);
    }
    if(dayRes.ok){
      const dir=dayRes.pct>=0?'▲':'▼',cls=dayRes.pct>=0?'ok':'bad';
      let weekendHint=''; try{const dL=new Date(dayRes.latest).getDay(),dP=new Date(dayRes.prior).getDay(); if(dL===1&&dP===5) weekendHint=' (Fri → Mon)';}catch(_){ }
      parts.push(`<div class="pill ${cls}" style="margin-top:8px"><i class="fa-solid fa-chart-line"></i> Prev day (${dayRes.etf}, ${dayRes.source}): ${dir} ${dayRes.pct.toFixed(2)}% (close ${dayRes.latest}${weekendHint})</div>`);
    } else {
      parts.push(`<div class="muted" style="margin-top:8px">Last day summary unavailable${dayRes.reason?' ('+dayRes.reason+')':''}</div>`);
    }
    try{
      const showWhy=dayRes?.ok&&Math.abs(dayRes.pct)>=WHY_PCT;
      if(showWhy){
        const why=buildWhyNarrative({dayRes,headlines:(newsRes.ok?newsRes.headlines:[])});
        parts.push(`<p style="margin-top:10px"><strong>Why?</strong> ${why}</p>`);
      }
    }catch(_){ }
    summaryEl.innerHTML=parts.join('');
    if(dayRes.ok&&dayRes.closes?.length) drawSparkline(summaryEl,dayRes.closes);
  }

  /* ---------------- Intraday fetch ---------------- */
  async function fetchIntraday(etf){
    const u = \`https://query1.finance.yahoo.com/v8/finance/chart/\${encodeURIComponent(etf)}?range=1d&interval=1m&includePrePost=true&t=\${Date.now()}\`;
    const data = await fetchJsonRetry(PROXY_RAW + encodeURIComponent(u), 2);
    const r = data?.chart?.result?.[0];
    const q = r?.indicators?.quote?.[0];
    const ts = r?.timestamp || [];
    const out = [];
    for (let i = 0; i < ts.length; i++) {
      const o=q?.open?.[i], h=q?.high?.[i], l=q?.low?.[i], c = q?.close?.[i], v = q?.volume?.[i];
      if (c != null && h!=null && l!=null && o!=null && v != null) out.push({ t: ts[i] * 1000, o, h, l, c, v });
    }
    const reg = r?.meta?.currentTradingPeriod?.regular;
    const regStart = (reg?.start ? reg.start * 1000 : null);
    const regEnd   = (reg?.end   ? reg.end   * 1000 : null);
    return { bars: out, regStart, regEnd };
  }
  function filterToSession(bars, regStart, regEnd){
    if (regStart && regEnd) {
      return bars.filter(b => b.t >= regStart && b.t <= Math.min(Date.now(), regEnd));
    }
    const MAX_MIN = 390; // fallback: last day
    return bars.slice(-MAX_MIN);
  }
  function selectWindow(bars, minutes){
    if(!bars.length) return [];
    const desired = Math.max(15, minutes);
    const cutoff  = Date.now() - minutes*60*1000;
    let recent    = bars.filter(b=>b.t >= cutoff);
    if(recent.length < desired) recent = bars.slice(-desired);
    if(recent.length > desired+2) recent = recent.slice(-desired);
    return recent;
  }

  function statsTrend(windowBars){
    if(windowBars.length<5) return {ok:false,reason:'not enough bars'};
    const closes=windowBars.map(b=>b.c), vols=windowBars.map(b=>b.v);
    const first=closes[0], last=closes.at(-1);
    const pct=(last-first)/first*100, delta=last-first;
    const rets=[]; for(let i=1;i<closes.length;i++){ const r=(closes[i]-closes[i-1])/closes[i-1]; if(isFinite(r)) rets.push(r); }
    const mean=rets.reduce((a,b)=>a+b,0)/Math.max(1,rets.length);
    const varr=rets.reduce((a,b)=>a+(b-mean)*(b-mean),0)/Math.max(1,rets.length);
    const std=Math.sqrt(varr);
    const median=arr=>{const a=[...arr].sort((x,y)=>x-y); const m=Math.floor(a.length/2); return a.length%2?a[m]:(a[m-1]+a[m])/2;};
    const volMed=median(vols), volAvg=vols.reduce((a,b)=>a+b,0)/vols.length, volRatio=volMed>0?volAvg/volMed:1;
    let sx=0,sy=0,sxx=0,sxy=0; for(let i=0;i<closes.length;i++){ sx+=i; sy+=closes[i]; sxx+=i*i; sxy+=i*closes[i]; }
    const n=closes.length, denom=(n*sxx - sx*sx)||1; const slope=(n*sxy - sx*sy)/denom; const slopePctPerHour=(slope/first)*60*100;
    let direction='Sideways',dirClass='warn'; if(pct>=0.2||slopePctPerHour>=0.5){direction='Uptrend';dirClass='ok'} else if(pct<=-0.2||slopePctPerHour<=-0.5){direction='Downtrend';dirClass='bad'}
    const busy=(std>=0.0006)||(volRatio>=1.20); const busyLabel=busy?'Busy':'Calmer',busyClass=busy?'ok':'warn';
    return {ok:true,pct,delta,std,volRatio,slopePctPerHour,direction,dirClass,busyLabel,busyClass,closes,bars:windowBars}
  }

  function tradeSuggestion(info){
    if(!info?.ok) return {text:'—',action:'Wait'};
    if(info.direction==='Uptrend'&&info.busyLabel==='Busy') return {text:'Recommend: <b>Buy</b> (uptrend + active tape)',action:'Buy'};
    if(info.direction==='Downtrend'&&info.busyLabel==='Busy') return {text:'Recommend: <b>Sell</b> (downtrend + active tape)',action:'Sell'};
    if(info.direction==='Uptrend') return {text:'Recommend: <b>Buy (cautious)</b> (uptrend, calmer tape)',action:'Buy'};
    if(info.direction==='Downtrend') return {text:'Recommend: <b>Sell (cautious)</b> (downtrend, calmer tape)',action:'Sell'};
    return {text:'Recommend: <b>Wait</b> (sideways / mixed)',action:'Wait'};
  }

  function computeVWAP(bars){
    let cumPV=0,cumV=0; const out=[];
    for(const b of bars){ cumPV+= (b.c||b.o)*(b.v||1); cumV+= (b.v||1); out.push(cumPV/Math.max(1,cumV)); }
    return out;
  }

  function marketPrediction(info,bars){
    if(!info?.ok||!bars?.length) return {label:'Neutral',conf:0.5,text:'Market bias unclear'};
    const N=Math.min(15,bars.length), lastN=bars.slice(-N);
    const closes=lastN.map(b=>b.c);
    const vwap=computeVWAP(lastN).at(-1);
    const last=closes.at(-1);
    let score=0;
    if(info.direction==='Uptrend') score+=1; else if(info.direction==='Downtrend') score-=1;
    score+=Math.tanh(info.slopePctPerHour/1.2);
    if(last>vwap) score+=0.6; else score-=0.6;
    let ups=0,downs=0; for(let i=1;i<lastN.length;i++){const d=lastN[i].c-lastN[i-1].c; if(d>0) ups++; else if(d<0) downs++;}
    if(ups>downs) score+=0.4; else if(downs>ups) score-=0.4;
    const volAdj=Math.max(0.35,Math.min(1,info.busyLabel==='Busy'?1:0.6));
    const conf=Math.max(0.5,Math.min(0.95,(0.6+Math.abs(score)/3)*volAdj));
    const label=score>0.25?'Bullish':(score<-0.25?'Bearish':'Range/Neutral');
    const text=label==='Bullish'?'likely to stay bullish':(label==='Bearish'?'may turn/continue bearish':'likely range-bound');
    return {label,conf,text};
  }

  function setLegend(el){
    if(!el) return;
    el.innerHTML = `
      <span class="item"><span class="swatch" style="background:#6abd74"></span> Up candle</span>
      <span class="item"><span class="swatch" style="background:#e05d5d"></span> Down candle</span>
      <span class="item" style="color:var(--accent-graph)"><span class="swatch line" style="color:var(--accent-graph)"></span> Close line</span>
      <span class="item" style="color:var(--accent)"><span class="swatch line dashed" style="color:var(--accent)"></span> VWAP (proxy)</span>`;
  }

  /* ---------------- Trend ---------------- */
  async function buildTrend(markets){
    const etf=FUTURES_TO_ETF[markets[0]||'ES']||'SPY';
    trendSymEl.textContent=etf; trendTimeEl.textContent=new Date().toLocaleString();
    trendSummaryEl.innerHTML='<span class="spinner"></span> Loading 1-minute bars...'; trendAdviceEl.innerHTML='';
    try{
      const all=await fetchIntraday(etf); const sessionBars=filterToSession(all.bars, all.regStart, all.regEnd); const win=selectWindow(sessionBars,trendMinutes); const info=statsTrend(win);
      if(!info.ok){trendSummaryEl.innerHTML=`<span class="muted">Trend unavailable (${info.reason})</span>`;drawTrend(trendCanvas,[]);return}
      const dirPill=`<span class="pill ${info.dirClass}"><i class="fa-solid fa-arrow-trend-${info.direction==='Downtrend'?'down':'up'}"></i> ${info.direction}</span>`;
      const busyPill=`<span class="pill ${info.busyClass}"><i class="fa-solid fa-bolt"></i> ${info.busyLabel}</span>`;
      const pctStr=`${info.pct>=0?'▲':'▼'} ${info.pct.toFixed(2)}%`;
      const slopeStr=`${info.slopePctPerHour>=0?'+':''}${info.slopePctPerHour.toFixed(2)}%/hr slope`;
      const volStr=`σ(1m) ${(info.std*100).toFixed(3)}% • Vol ratio ${info.volRatio.toFixed(2)}×`;
      trendSummaryEl.innerHTML=`${dirPill} ${busyPill}<div style="margin-top:8px" class="muted">${pctStr} • ${slopeStr} • ${volStr}</div>`;
      drawTrend(trendCanvas,win);
      setLegend(trendLegend);
      const advice=tradeSuggestion(info);
      const pred=marketPrediction(info, win);
      trendAdviceEl.innerHTML = `
        <div class="pill" style="margin-top:10px;background:#2b2a31;border-color:#3a3941">
          <i class="fa-solid fa-lightbulb"></i>&nbsp; ${advice.text}
          &nbsp;<button class="pill" id="whyBtn">Why?</button>
        </div>
        <div class="muted" style="margin-top:6px;font-size:12px">
          Prediction: <b>${pred.label}</b> (${Math.round(pred.conf*100)}% conf) — ${pred.text}.<br>
          Disclaimer: For informational purposes only; not financial advice.
        </div>
      `;
      const whyBtn=document.getElementById('whyBtn');
      if(whyBtn){
        whyBtn.onclick=()=>{
          whyBody.textContent = `Direction: ${info.direction}; Busy: ${info.busyLabel}; Slope: ${info.slopePctPerHour.toFixed(2)}%/hr; σ(1m): ${(info.std*100).toFixed(3)}%; Vol ratio: ${info.volRatio.toFixed(2)}×. Prediction: ${pred.label} (${Math.round(pred.conf*100)}%).`;
          whyModal.style.display='flex';
        };
      }
      document.getElementById('trendRef').textContent=new Date().toLocaleTimeString();
    }catch(e){
      trendSummaryEl.innerHTML=`<span class="bad">Error:</span> ${String(e).slice(0,140)}`;
    }
  }

  /* ---------------- Risk ---------------- */
  let riskMode='conservative';
  const riskModeSeg=document.getElementById('riskModeSeg');
  let riskCandlesN=3;
  const riskCandles=document.getElementById('riskCandles'), riskCandlesLabel=document.getElementById('riskCandlesLabel');

  if(riskModeSeg){
    riskModeSeg.addEventListener('click',e=>{
      const btn=e.target.closest('.segbtn'); if(!btn) return;
      riskMode=btn.dataset.mode||'conservative';
      Array.from(riskModeSeg.querySelectorAll('.segbtn')).forEach(b=>b.classList.toggle('active',b===btn));
      const m=getSelectedFutures(); buildRisk(m.length?m:['ES']);
    });
  }
  if(riskCandles){
    const syncLabel=()=>riskCandlesLabel.textContent=`${riskCandles.value} candles`;
    riskCandles.addEventListener('input',()=>{riskCandlesN=parseInt(riskCandles.value,10)||3;syncLabel()});
    riskCandles.addEventListener('change',()=>{riskCandlesN=parseInt(riskCandles.value,10)||3;const m=getSelectedFutures();buildRisk(m.length?m:['ES'])});
    syncLabel();
  }

  function lastNSignal(bars,N){
    const seg=(bars||[]).slice(-N); if(seg.length<N) return {text:'Recommend: <b>Wait</b> (need more bars)',action:'Wait',pct:0,up:false,dn:false};
    let up=true,dn=true; for(let i=1;i<seg.length;i++){if(!(seg[i].c>seg[i-1].c)) up=false; if(!(seg[i].c<seg[i-1].c)) dn=false;}
    const pct=((seg.at(-1).c - seg[0].c)/seg[0].c)*100;
    const base=0.05, thresh=base*(N/3);
    if(up && pct>=thresh) return {text:`Recommend: <b>Buy</b> (Aggressive: last ${N} higher)`,action:'Buy',pct};
    if(dn && pct<=-thresh) return {text:`Recommend: <b>Sell</b> (Aggressive: last ${N} lower)`,action:'Sell',pct};
    return {text:`Recommend: <b>Wait</b> (Aggressive: choppy; Δ ${pct.toFixed(2)}%)`,action:'Wait',pct};
  }

  async function buildRisk(markets){
    const etf=FUTURES_TO_ETF[markets[0]||'ES']||'SPY';
    riskSymEl.textContent=etf; riskTimeEl.textContent=new Date().toLocaleString();
    riskSummaryEl.innerHTML='<span class="spinner"></span> Loading 1-minute bars...'; riskAdviceEl.innerHTML='';
    try{
      const all=await fetchIntraday(etf); const sessionBars=filterToSession(all.bars, all.regStart, all.regEnd); const win=selectWindow(sessionBars,trendMinutes);
      drawRisk(riskCanvas,win); setLegend(riskLegend);
      const info=statsTrend(win);
      let advice;
      if(riskMode==='aggressive'){ advice=lastNSignal(win,riskCandlesN); }
      else {
        if(!info.ok){ advice={text:'Recommend: <b>Wait</b> (need more data)',action:'Wait'}; }
        else {
          advice = (info.busyLabel==='Busy')
            ? (info.direction==='Uptrend' ? {text:'Recommend: <b>Smaller size Buy</b> (Busy uptrend)',action:'Buy'} : (info.direction==='Downtrend' ? {text:'Recommend: <b>Smaller size Sell</b> (Busy downtrend)',action:'Sell'} : {text:'Recommend: <b>Wait</b> (Busy but sideways)',action:'Wait'}))
            : {text:'Recommend: <b>Wait</b> (Calmer tape)',action:'Wait'};
        }
      }
      riskSummaryEl.innerHTML = `<span class="pill ${info.dirClass}">${info.direction||'—'}</span> <span class="pill ${info.busyClass}">${info.busyLabel||'—'}</span>`;
      riskAdviceEl.innerHTML = `<div class="pill" style="margin-top:10px;background:#2b2a31;border-color:#3a3941">${advice.text}</div>`;
      document.getElementById('riskRef').textContent=new Date().toLocaleTimeString();
    }catch(e){
      riskSummaryEl.innerHTML=`<span class="bad">Error:</span> ${String(e).slice(0,140)}`;
    }
  }

  /* ---------------- P&L (localStorage + optional API) ---------------- */
  function readPnL(){try{return JSON.parse(localStorage.getItem('PNL_LOG')||'[]')}catch(_){return []}}
  function writePnL(arr){localStorage.setItem('PNL_LOG',JSON.stringify(arr))}
  function todayStr(){const d=new Date();return d.toISOString().slice(0,10)}
  function renderTodayPnL(){
    const rows=readPnL().filter(x=>x.date===todayStr());
    if(!rows.length){pnlTodayTable.textContent='—';return}
    const html=['<table style="width:100%;border-collapse:collapse">','<tr class="muted"><td>Date</td><td>Who</td><td>Amount</td><td>Note</td></tr>'];
    rows.forEach(r=>html.push(`<tr><td>${r.date}</td><td>${r.who}</td><td>${(r.amt>=0?'+':'')+r.amt.toFixed(2)}</td><td>${r.note||''}</td></tr>`));
    html.push('</table>');
    pnlTodayTable.innerHTML=html.join('');
  }
  function sumPnL(name){return readPnL().filter(x=>x.who===name).reduce((a,b)=>a+b.amt,0)}
  function sumPnLToday(name){return readPnL().filter(x=>x.who===name && x.date===todayStr()).reduce((a,b)=>a+b.amt,0)}
  function updatePnLChips(){
    const ak=sumPnLToday('AK'), bg=sumPnLToday('BG'), akAll=sumPnL('AK'), bgAll=sumPnL('BG');
    chipAK.textContent='$'+ak.toFixed(2); chipAKAll.textContent='$'+akAll.toFixed(2);
    chipBG.textContent='$'+bg.toFixed(2); chipBGAll.textContent='$'+bgAll.toFixed(2);
  }
  async function submitPnLToApi(entry){
    if(!PNL_TOKEN || PNL_TOKEN==='CHANGE_ME_32CHAR') return;
    try{
      await fetch(PNL_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...entry, token:PNL_TOKEN})});
    }catch(_){/* ignore */}
  }

  const pnlAmount=document.getElementById('pnlAmount'), pnlNote=document.getElementById('pnlNote'), pnlMsg=document.getElementById('pnlMsg'), pnlTodayTable=document.getElementById('pnlTodayTable');
  const undoLast=document.getElementById('undoLast');
  document.getElementById('logPnl').onclick=async()=>{
    const who=(document.querySelector('input[name="who"]:checked')||{}).value||'AK';
    const amt=parseFloat(pnlAmount.value);
    if(!isFinite(amt)){pnlMsg.textContent='Enter a valid number';setTimeout(()=>pnlMsg.textContent='',1200);return}
    const entry={date:todayStr(),who,amt,note:pnlNote.value.trim()};
    const arr=readPnL(); arr.push(entry); writePnL(arr); submitPnLToApi(entry);
    pnlAmount.value=''; pnlNote.value=''; renderTodayPnL(); updatePnLChips();
    pnlMsg.textContent='Logged ✓'; setTimeout(()=>pnlMsg.textContent='',1200);
  };
  undoLast.onclick=()=>{const arr=readPnL(); if(!arr.length) return; arr.pop(); writePnL(arr); renderTodayPnL(); updatePnLChips();};

  /* ---------------- Prep wiring ---------------- */
  async function handlePrep(){
    const m=getSelectedFutures(); const markets=m.length?m:['ES','NQ'];
    showPrepHeader(markets); makeLinks(markets);
    await buildSummary(markets);
  }

  async function handleTrend(){const m=getSelectedFutures(); await buildTrend(m.length?m:['ES']);}
  async function handleRisk(){const m=getSelectedFutures(); await buildRisk(m.length?m:['ES']);}

  // Buttons
  startBtn.onclick=handlePrep;
  runTrendBtn.onclick=()=>{setTab('trend'); handleTrend();};
  runRiskBtn.onclick=()=>{setTab('risk'); handleRisk();};

  // Tabs
  tabPrep.onclick=()=>{setTab('prep')};
  tabTrend.onclick=()=>{setTab('trend'); handleTrend();};
  tabRisk.onclick=()=>{setTab('risk'); handleRisk();};

  // Why modal close
  whyClose.onclick=()=>whyModal.style.display='none';
  whyModal.addEventListener('click',e=>{if(e.target===whyModal) whyModal.style.display='none'});

  // Mobile menu
  (function(){const btn=document.getElementById('mobileMenu');const nav=document.getElementById('navicons');if(btn&&nav){btn.addEventListener('click',()=>nav.classList.toggle('show'));}})();

  // On load defaults
  window.addEventListener('load',()=>{
    // default select ES,NQ
    for(const o of futuresSel.options){o.selected=(o.value==='ES'||o.value==='NQ');}
    setTfActive(15);
    handlePrep();
    renderTodayPnL(); updatePnLChips();
  });
  </script>
</body>
</html>
