<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#1b191b"/>
  <meta name="color-scheme" content="dark"/>
  <title>Trader Prep</title>

  <!-- Icons / Manifest -->
  <link rel="icon" href="favicon-32.png" sizes="32x32" type="image/png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Icons (CDN, free) -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer"/>

  <style>
    :root {
      --bg:#1b191b; --panel:#2a292f; --panel-2:#242328; --line:#35343a;
      --fg:#f1f2f4; --muted:#a7adbb;
      --accent:#6f5aff; --accent-graph:#7c5cff;
      --ok:#6abd74; --bad:#e05d5d; --warn:#d3a54a; --pill:#24252b;
      --shadow:0 6px 18px rgba(0,0,0,.35); --radius:14px; --pad:16px;
    }
    html,body{background:var(--bg);color:var(--fg)}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;margin:0;line-height:1.35;word-break:normal}
    a{color:inherit}

    /* Top bar */
    .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,#201f25 0%,#1a191f 100%);border-bottom:1px solid var(--line);padding:10px 14px}
    .brand{display:flex;gap:10px;align-items:center;min-width:0}
    .brand .logo{width:36px;height:36px;display:grid;place-items:center;border-radius:10px;background:#2f2e36;border:1px solid var(--line);overflow:hidden;flex:0 0 auto}
    .brand h1{font-size:16px;margin:0;letter-spacing:.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand-dropdown{display:none}
    .navicons{display:flex;gap:10px;align-items:center}
    .iconbtn{min-width:44px;min-height:44px;display:grid;place-items:center;border-radius:12px;border:1px solid var(--line);background:#26252b;cursor:pointer;color:#cfd3dc}
    .iconbtn.active{background:var(--accent);color:#090909;border-color:transparent}

    /* Stat strip */
    .statstrip{display:flex;gap:10px;align-items:center;padding:10px 14px;flex-wrap:wrap;border-bottom:1px solid var(--line);background:#1e1d22}
    .chip{display:flex;gap:8px;align-items:center;padding:6px 10px;background:#2a2930;border:1px solid var(--line);border-radius:10px;font-size:12px}
    .chip.ok{background:#213224;color:var(--ok);border-color:#2a4930}
    .chip.warn{background:#332d1f;color:var(--warn);border-color:#5a4726}
    .chip.bad{background:#372325;color:var(--bad);border-color:#5d3439}

    /* Shell */
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow);margin:14px 0}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button,select,input{font-size:15px}
    select,input{background:var(--panel-2);color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:12px 12px;width:100%}
    button{padding:12px 16px;border-radius:12px;border:1px solid var(--line);background:var(--panel-2);color:var(--fg);cursor:pointer}
    .primary{background:var(--accent);color:#0b0b10;border-color:transparent;font-weight:600}
    .tabs{display:flex;gap:10px;margin:8px 0 2px;flex-wrap:wrap}
    .tabbtn{border-radius:10px;border:1px solid var(--line);background:#26252b;padding:8px 12px;cursor:pointer}
    .tabbtn.active{background:var(--accent);color:#0b0b10;border-color:transparent}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 12px;border-radius:999px;background:var(--pill);border:1px solid var(--line);font-size:13px;white-space:nowrap}
    .pill.accent{background:var(--accent);color:#0b0b10;border-color:transparent}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    details summary{cursor:pointer}
    .bundles{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .bundle{padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#26252b;font-size:14px;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    /* Chart canvas */
    .chart{width:100%;height:190px;border-radius:10px;background:#24252b;margin-top:10px;display:block}
    .legend{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:8px;font-size:12px;color:var(--muted)}
    .legend .item{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#26252b;white-space:nowrap}
    .swatch{display:inline-block;width:20px;height:10px;border-radius:2px}
    .swatch.line{width:28px;height:0;border-top:3px solid currentColor}
    .swatch.dashed{border-top-style:dashed}

    .seg{display:flex;gap:8px;flex-wrap:wrap}
    .segbtn{padding:8px 12px;border:1px solid var(--line);background:#26252b;border-radius:10px;cursor:pointer}
    .segbtn.active{background:var(--accent);color:#0b0b10;border-color:transparent}
    .spinner{display:inline-block;width:18px;height:18px;border:3px solid #45434c;border-top-color:#ddd;border-radius:50%;animation:spin 1s linear infinite;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .flash{animation:flash .6s ease}@keyframes flash{0%{color:var(--ok)}100%{color:var(--muted)}}
    .sliderrow{display:flex;align-items:center;gap:10px;flex-wrap:nowrap}
    .sliderrow input[type=range]{width:200px}

    /* Mobile tweaks */
    @media (max-width:520px){
      .brand h1{display:none}
      .brand-dropdown{display:block;color:var(--fg);cursor:pointer}
      .chip{font-size:11px}
      .tabbtn,button{padding:10px 12px}
      .legend{font-size:11px}
    }

    /* Popup modal */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal-content{background:var(--panel);padding:20px;border-radius:12px;max-width:400px;box-shadow:var(--shadow)}
    .modal-content h3{margin-top:0}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="topbar">
    <div class="brand">
      <div class="logo"><img src="icon-192.png" alt="Trader Prep Logo" style="width:100%;height:100%;object-fit:contain"></div>
      <h1>Trader Prep</h1>
      <div class="brand-dropdown"><i class="fa-solid fa-caret-down"></i></div>
    </div>
    <nav class="navicons">
      <div class="iconbtn active" id="nav-prep" title="Prep"><i class="fa-solid fa-bars-staggered"></i></div>
      <div class="iconbtn" id="nav-trend" title="Trend"><i class="fa-solid fa-wave-square"></i></div>
      <div class="iconbtn" id="nav-risk" title="Risk"><i class="fa-solid fa-fire-flame-curved"></i></div>
      <div class="iconbtn" id="nav-pnl" title="Profit Log"><i class="fa-solid fa-dollar-sign"></i></div>
      <div class="iconbtn" id="nav-settings" title="Settings"><i class="fa-solid fa-gear"></i></div>
    </nav>
  </header>

  <!-- Popup modal -->
  <div class="modal" id="explainModal">
    <div class="modal-content">
      <h3>Why this suggestion?</h3>
      <div id="explainBody">—</div>
      <div style="text-align:right;margin-top:12px"><button onclick="closeExplain()">Close</button></div>
    </div>
  </div>

  <!-- CONTENT (unchanged until scripts)... -->

  <script>
    // Mobile brand dropdown toggle
    const brandDropdown=document.querySelector('.brand-dropdown');
    if(brandDropdown){brandDropdown.onclick=()=>alert('Trader Prep');}

    function openExplain(text){
      document.getElementById('explainBody').innerHTML=text;
      document.getElementById('explainModal').style.display='flex';
    }
    function closeExplain(){
      document.getElementById('explainModal').style.display='none';
    }

    // Example hook: wrap tradeSuggestion output clickable
    function clickableSuggestion(htmlText, debug){
      return `<span onclick="openExplain('${(debug?JSON.stringify(debug):htmlText).replace(/"/g,'&quot;')}')" style="cursor:pointer;text-decoration:underline">${htmlText}</span>`;
    }

    // integrate with tradeSuggestion
    function tradeSuggestion(info){
      if(!info?.ok) return {text: clickableSuggestion('—'),action:'Wait'};
      let base,act;
      if(info.direction==='Uptrend'&&info.busyLabel==='Busy'){base='Recommend: <b>Buy</b> (uptrend + active tape)';act='Buy'}
      else if(info.direction==='Downtrend'&&info.busyLabel==='Busy'){base='Recommend: <b>Sell</b> (downtrend + active tape)';act='Sell'}
      else if(info.direction==='Uptrend'){base='Recommend: <b>Buy (cautious)</b> (uptrend, calmer tape)';act='Buy'}
      else if(info.direction==='Downtrend'){base='Recommend: <b>Sell (cautious)</b> (downtrend, calmer tape)';act='Sell'}
      else {base='Recommend: <b>Wait</b> (sideways / mixed)';act='Wait'}
      return {text: clickableSuggestion(base,info),action:act};
    }

    // replace marketPrediction with upgraded version (from earlier)
    function sigmoid(x){ return 1/(1+Math.exp(-x)); }
    function stdev(arr){if(!arr.length) return 0;const m=arr.reduce((a,b)=>a+b,0)/arr.length;const v=arr.reduce((a,b)=>a+(b-m)*(b-m),0)/arr.length;return Math.sqrt(v);}
    function mad(arr){if(!arr.length) return 0;const m=arr.reduce((a,b)=>a+b,0)/arr.length;const dev=arr.map(x=>Math.abs(x-m)).sort((a,b)=>a-b);const mid=Math.floor(dev.length/2);return dev.length%2?dev[mid]:(dev[mid-1]+dev[mid])/2;}
    function ema(arr,alpha=0.2){const out=[];let s=null;for(const x of arr){s=(s==null)?x:alpha*x+(1-alpha)*s;out.push(s);}return out;}
    function slopePctPerHour(values){if(values.length<3) return 0;const first=values[0];let sx=0,sy=0,sxx=0,sxy=0;for(let i=0;i<values.length;i++){sx+=i;sy+=values[i];sxx+=i*i;sxy+=i*values[i];}const n=values.length,denom=(n*sxx-sx*sx)||1;const slope=(n*sxy-sx*sy)/denom;return (first>0)?(slope/first)*60*100:0;}
    function marketPrediction(info,bars){
      if(!info?.ok||!bars?.length) return {label:'Neutral',conf:0.5,text:'Market bias unclear'};
      const N=Math.min(15,bars.length);
      const K=Math.min(8,N);
      const lastN=bars.slice(-N);
      const closes=lastN.map(b=>b.c);
      let cumPV=0,cumV=0;const vwap=lastN.map(b=>{cumPV+=b.c*(b.v||1);cumV+=(b.v||1);return cumPV/Math.max(1,cumV);});
      const returns=[];for(let i=1;i<closes.length;i++){const r=(closes[i]-closes[i-1])/closes[i-1];if(isFinite(r))returns.push(r);}
      const retStd=stdev(returns)||1e-6;
      const dv=(closes.at(-1)-vwap.at(-1))/(closes.at(-1)||1);
      const zVWAP=dv/retStd;
      const vwapSlope=slopePctPerHour(vwap);
      const e=ema(closes,0.25);
      const emaSlope=slopePctPerHour(e);
      let ups=0,downs=0;for(let i=1;i<closes.length;i++){const d=closes[i]-closes[i-1];if(d>0)ups++;else if(d<0)downs++;}
      const breadthSigned=2*(ups/(ups+downs||1))-1;
      const deltas=[];for(let i=1;i<closes.length;i++){deltas.push(closes[i]-closes[i-1]);}
      const m=mad(deltas)||1e-6;const lastDelta=deltas.at(-1)||0;const impulse=lastDelta/m;
      const regime=(info.busyLabel==='Busy')?1:0;
      const score=0.95*Math.max(-3,Math.min(3,zVWAP))+1.0*Math.max(-1.5,Math.min(1.5,vwapSlope/1.0))+0.85*Math.max(-1.5,Math.min(1.5,emaSlope/1.0))+0.60*breadthSigned+0.40*Math.max(-2,Math.min(2,impulse))+0.30*(regime?0.5:0);
      const p=sigmoid(score);
      let label='Neutral';if(p>=0.60)label='Bullish';else if(p<=0.40)label='Bearish';
      const conf=Math.max(0.55,Math.min(0.99,0.5+Math.abs(p-0.5)*1.4));
      const text=(label==='Bullish')?`likely to stay bullish (${Math.round(conf*100)}% conf)`:((label==='Bearish')?`may go bearish (${Math.round(conf*100)}% conf)`: `mixed / no clear edge (${Math.round(conf*100)}% conf)`);
      return {label,conf,text,p,debug:{zVWAP,vwapSlope,emaSlope,breadthSigned,impulse,regime,score}};
    }
  </script>
</body>
</html>
